{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">University Management</h1>

    <!-- Form to Add/Update University -->
    <form id="universityForm" class="mb-4">
        <input type="hidden" id="universityId">
        <div class="row g-3">
            <div class="col-md-6">
                <input type="text" class="form-control" id="name" placeholder="Name" required>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" id="location" placeholder="Location" required>
            </div>
            <div class="col-md-3">
                <input type="number" step="0.01" class="form-control" id="bachelor_fee" placeholder="Bachelor Fee">
            </div>
            <div class="col-md-3">
                <input type="number" step="0.01" class="form-control" id="master_fee" placeholder="Master Fee">
            </div>
            <div class="col-md-3">
                <input type="number" step="0.01" class="form-control" id="phd_fee" placeholder="PhD Fee">
            </div>
            <div class="col-md-3">
                <input type="number" step="0.01" class="form-control" id="hnd_fee" placeholder="HND Fee">
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" id="language" placeholder="Language" required>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" id="programs" placeholder='Programs (JSON: {"bachelors": {...}})' required>
            </div>
            <div class="col-md-2">
                <input type="number" step="0.0001" class="form-control" id="x_coordinate" placeholder="X Coordinate" required>
            </div>
            <div class="col-md-2">
                <input type="number" step="0.0001" class="form-control" id="y_coordinate" placeholder="Y Coordinate" required>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary w-100">Save University</button>
            </div>
        </div>
    </form>

    <!-- University List -->
    <div id="universityList" class="row g-4"></div>
</div>

<script>
    const apiUrl = '/members/api/universities/';

    // Fetch and display universities
    function loadUniversities() {
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('universityList');
                list.innerHTML = '';
                data.forEach(university => {
                    const card = `
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">${university.name}</h5>
                                    <p><strong>Location:</strong> ${university.location}</p>
                                    <p><strong>Fees:</strong> B: ${university.bachelor_fee || '-'}, M: ${university.master_fee || '-'}</p>
                                    <p><strong>Language:</strong> ${university.language}</p>
                                    <p><strong>Coordinates:</strong> (${university.x_coordinate}, ${university.y_coordinate})</p>
                                    <p><strong>Programs:</strong></p>
                                    <div class="program-list">
                                        ${Object.values(university.programs).flatMap(cat => 
                                            Object.values(cat).flat()).map(prog => `<span class="program-item">${prog}</span>`).join('')}
                                    </div>
                                    <button class="btn btn-warning mt-2" onclick="editUniversity(${university.id})">Edit</button>
                                    <button class="btn btn-danger mt-2" onclick="deleteUniversity(${university.id})">Delete</button>
                                </div>
                            </div>
                        </div>`;
                    list.innerHTML += card;
                });
            });
    }

    // Form submission (Create/Update)
    document.getElementById('universityForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('universityId').value;
        const university = {
            name: document.getElementById('name').value,
            location: document.getElementById('location').value,
            bachelor_fee: document.getElementById('bachelor_fee').value || null,
            master_fee: document.getElementById('master_fee').value || null,
            phd_fee: document.getElementById('phd_fee').value || null,
            hnd_fee: document.getElementById('hnd_fee').value || null,
            language: document.getElementById('language').value,
            programs: JSON.parse(document.getElementById('programs').value),
            x_coordinate: document.getElementById('x_coordinate').value,
            y_coordinate: document.getElementById('y_coordinate').value,
            university_url: "https://example.com"  // Optional
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${apiUrl}${id}/` : apiUrl;

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(university)
        }).then(() => {
            loadUniversities();
            this.reset();
            document.getElementById('universityId').value = '';
        });
    });

    // Edit university
    function editUniversity(id) {
        fetch(`${apiUrl}${id}/`)
            .then(response => response.json())
            .then(university => {
                document.getElementById('universityId').value = university.id;
                document.getElementById('name').value = university.name;
                document.getElementById('location').value = university.location;
                document.getElementById('bachelor_fee').value = university.bachelor_fee;
                document.getElementById('master_fee').value = university.master_fee;
                document.getElementById('phd_fee').value = university.phd_fee;
                document.getElementById('hnd_fee').value = university.hnd_fee;
                document.getElementById('language').value = university.language;
                document.getElementById('programs').value = JSON.stringify(university.programs);
                document.getElementById('x_coordinate').value = university.x_coordinate;
                document.getElementById('y_coordinate').value = university.y_coordinate;
            });
    }

    // Delete university
    function deleteUniversity(id) {
        if (confirm('Are you sure?')) {
            fetch(`${apiUrl}${id}/`, { method: 'DELETE' })
                .then(() => loadUniversities());
        }
    }

    // Initial load
    loadUniversities();
</script>
{% endblock %}